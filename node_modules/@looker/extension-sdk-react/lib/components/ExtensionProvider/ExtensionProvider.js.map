{"version":3,"sources":["../../../src/components/ExtensionProvider/ExtensionProvider.tsx"],"names":["ExtensionContext","React","createContext","undefined","ExtensionProvider","onPathnameChange","onRouteChange","hostTracksRoute","loadingComponent","requiredLookerVersion","children","initialRouteData","setInitialRouteData","route","hostRouteData","setHostRouteData","initializing","setInitializing","initializeError","setInitializeError","useState","extensionData","setExtensionData","setInitialRouteAndRouteState","routeState","hostChangedRoute","_route","startsWith","previousState","useEffect","initialize","setInitialRoute","extensionHost","core31SDK","LookerExtensionSDK","create31Client","core40SDK","create40Client","extensionSDK","coreSDK","console","error","message","onBodyMousedown","closeHostPopovers","body","document","querySelector","addEventListener","removeEventListener","width","margin","padding","background","borderRadius","font"],"mappings":"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","sourcesContent":["/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2019 Looker Data Sciences, Inc.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in\n * all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n * THE SOFTWARE.\n */\n\nimport isEqual from 'lodash/isEqual'\nimport React, { useState } from 'react'\nimport { MemoryRouter } from 'react-router-dom'\nimport { LookerExtensionSDK, connectExtensionHost } from '@looker/extension-sdk'\nimport { Looker31SDK } from '@looker/sdk/lib/sdk/3.1/methods'\nimport { ExtensionProviderProps, ExtensionContextData, RouteData } from './types'\nimport { RouteChangeListener } from './components/RouteChangeListener'\nimport { registerCore31SDK, registerCore40SDK, unregisterCore31SDK, unregisterCore40SDK } from '../../sdk/core_sdk'\nimport { Looker40SDK } from '@looker/sdk/lib/sdk/4.0/methods'\nimport { getInitialRouteEntries } from './utils/get_initial_route_entries'\n\n/**\n * React context provider for extension API and SDK\n */\nexport const ExtensionContext = React.createContext<ExtensionContextData>(\n  undefined as any // no one will ever see this undefined!\n)\n\n/**\n * ExtensionProvider component. Provides access to the extension API and SDK (use\n * ExtensionContext) and react routing services.\n */\nexport const ExtensionProvider: React.FC<ExtensionProviderProps> = ({\n  onPathnameChange,\n  onRouteChange,\n  hostTracksRoute = true,\n  loadingComponent,\n  requiredLookerVersion,\n  children,\n}) => {\n  const [initialRouteData, setInitialRouteData] = useState<RouteData>()\n  const [hostRouteData, setHostRouteData] = useState<RouteData>({ route: '' })\n  const [initializing, setInitializing] = useState(true)\n  const [initializeError, setInitializeError] = useState<string>()\n  const [extensionData, setExtensionData] = React.useState<ExtensionContextData>({} as ExtensionContextData)\n\n  const setInitialRouteAndRouteState = (route: string, routeState?: any) => {\n    if (hostTracksRoute) {\n      setInitialRouteData({ route, routeState })\n    }\n  }\n\n  const hostChangedRoute = (_route: string, routeState?: any) => {\n    const route = _route.startsWith('/') ? _route : '/' + _route\n    if (route !== hostRouteData.route || !isEqual(routeState, hostRouteData.routeState)) {\n      setHostRouteData({ route, routeState })\n      setExtensionData((previousState: ExtensionContextData) => {\n        return {\n          ...previousState,\n          route,\n          routeState,\n        }\n      })\n    }\n  }\n\n  React.useEffect(() => {\n    const initialize = async () => {\n      try {\n        const extensionHost = await connectExtensionHost({\n          setInitialRoute: setInitialRouteAndRouteState,\n          requiredLookerVersion,\n          hostChangedRoute,\n        })\n        const core31SDK: Looker31SDK = LookerExtensionSDK.create31Client(extensionHost)\n        const core40SDK: Looker40SDK = LookerExtensionSDK.create40Client(extensionHost)\n        // Provide global access for use by redux if needed\n        registerCore31SDK(core31SDK)\n        registerCore40SDK(core40SDK)\n        setExtensionData((previousState: ExtensionContextData) => {\n          return {\n            ...previousState,\n            extensionSDK: extensionHost,\n            coreSDK: core31SDK,\n            core31SDK,\n            core40SDK,\n          }\n        })\n        setInitializing(false)\n      } catch (error) {\n        console.error(error)\n        unregisterCore31SDK()\n        unregisterCore40SDK()\n        setInitializeError(error.message || 'Extension failed to initialize.')\n        setInitializing(false)\n      }\n    }\n    initialize()\n    return () => {\n      unregisterCore31SDK()\n      unregisterCore40SDK()\n    }\n  }, [])\n\n  React.useEffect(() => {\n    const onBodyMousedown = () => {\n      if (extensionData && extensionData.extensionSDK) {\n        extensionData.extensionSDK.closeHostPopovers()\n      }\n    }\n    let body: HTMLBodyElement | undefined | null\n    if (!initializing) {\n      body = document.querySelector('body')\n      if (body) {\n        body.addEventListener('mousedown', onBodyMousedown)\n      }\n    }\n    return () => {\n      if (body) {\n        body.removeEventListener('mousedown', onBodyMousedown)\n      }\n    }\n  }, [initializing])\n\n  return (\n    <>\n      {initializing ? (\n        loadingComponent\n      ) : (\n        <>\n          {!!initializeError ? (\n            <div\n              id='extension-initialization-error'\n              aria-live='polite'\n              role='status'\n              style={{\n                width: '100%',\n                margin: '-8px',\n                padding: '12px 16px',\n                background: '#FFE5E9',\n                borderRadius: '4px',\n                font: '0.875rem \"Helvetica\", san-serif',\n              }}\n            >\n              {initializeError}\n            </div>\n          ) : (\n            <>\n              {hostTracksRoute ? (\n                <MemoryRouter initialEntries={getInitialRouteEntries(initialRouteData)}>\n                  <RouteChangeListener\n                    onRouteChange={onRouteChange}\n                    onPathnameChange={onPathnameChange}\n                    extensionHost={extensionData!.extensionSDK}\n                    hostRoute={hostRouteData.route}\n                    hostRouteState={hostRouteData.routeState}\n                  />\n                  <ExtensionContext.Provider value={extensionData!}>{children}</ExtensionContext.Provider>\n                </MemoryRouter>\n              ) : (\n                <ExtensionContext.Provider value={extensionData!}>{children}</ExtensionContext.Provider>\n              )}\n            </>\n          )}\n        </>\n      )}\n    </>\n  )\n}\n"],"file":"ExtensionProvider.js"}